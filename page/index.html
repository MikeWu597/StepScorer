<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StepScorer</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="font/bootstrap-icons.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">StepScorer</h1>
        
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab" aria-controls="data" aria-selected="true">① Data Preparation</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="training-tab" data-bs-toggle="tab" data-bs-target="#training" type="button" role="tab" aria-controls="training" aria-selected="false">② Model Training</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inference-tab" data-bs-toggle="tab" data-bs-target="#inference" type="button" role="tab" aria-controls="inference" aria-selected="false">③ Inference</button>
            </li>
        </ul>
        
        <!-- Tab panes -->
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="data" role="tabpanel" aria-labelledby="data-tab">
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">① Data Preparation</h5>
                        <p class="card-text">Upload your CSV dataset for training the StepScorer model.</p>
                        
                        <div class="alert alert-info" role="alert">
                            <strong>Dataset Format:</strong> The CSV file should contain three columns:
                            <ul>
                                <li><code>standard</code>: The scoring criteria</li>
                                <li><code>object</code>: The text to be scored</li>
                                <li><code>score</code>: The target score (numeric value)</li>
                            </ul>
                        </div>
                        
                        <div class="alert alert-secondary" role="alert">
                            <strong>File Path Information:</strong>
                            <ul class="mb-0">
                                <li>Uploaded datasets are stored in: <code>data/</code> directory</li>
                            </ul>
                        </div>
                        
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="datasetFile" class="form-label">Select CSV Dataset</label>
                                <input class="form-control" type="file" id="datasetFile" name="file" accept=".csv">
                            </div>
                            <button type="submit" class="btn btn-primary" id="uploadBtn">Upload Dataset</button>
                        </form>
                        
                        <div class="mt-3" id="uploadResult"></div>
                        
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Uploaded Datasets</h6>
                                <button class="btn btn-secondary btn-sm" id="refreshDatasets">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <div id="datasetsList">
                                <div class="alert alert-info">Click "Refresh" to load datasets</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="training" role="tabpanel" aria-labelledby="training-tab">
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">② Model Training</h5>
                        <p class="card-text">Train the StepScorer model with your prepared data.</p>
                        
                        <div class="alert alert-secondary" role="alert">
                            <strong>File Path Information:</strong>
                            <ul class="mb-0">
                                <li>Trained models are saved in: <code>checkpoints/</code> directory</li>
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <label for="datasetSelect" class="form-label">Select Dataset</label>
                            <select class="form-select" id="datasetSelect">
                                <option value="">Choose a dataset...</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-success" id="startTrainingBtn">Start Training</button>
                        <button class="btn btn-secondary" id="refreshTrainingDatasets">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Datasets
                        </button>
                        
                        <div class="mt-4">
                            <h6>Training Status</h6>
                            <div id="trainingStatus">
                                <div class="alert alert-info">Select a dataset and click "Start Training"</div>
                            </div>
                            
                            <h6 class="mt-4">Training Output</h6>
                            <div id="trainingOutput" class="bg-dark text-light p-3 overflow-auto" style="height: 300px; display: none;">
                                <pre id="trainingLog" class="mb-0 text-light"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="inference" role="tabpanel" aria-labelledby="inference-tab">
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">③ Inference</h5>
                        <p class="card-text">Use the trained model to score new text samples.</p>
                        
                        <div class="alert alert-secondary" role="alert">
                            <strong>File Path Information:</strong>
                            <ul class="mb-0">
                                <li>Generated figures are saved in: <code>figures/</code> directory</li>
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modelSelect" class="form-label">Select Model</label>
                            <select class="form-select" id="modelSelect">
                                <option value="">Choose a model...</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-secondary mb-3" id="refreshModels">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Models
                        </button>
                        
                        <div class="mb-3">
                            <label for="standardInput" class="form-label">Scoring Standard</label>
                            <input type="text" class="form-control" id="standardInput" placeholder="Enter scoring standard">
                        </div>
                        
                        <div class="mb-3">
                            <label for="objectInput" class="form-label">Object to Score</label>
                            <textarea class="form-control" id="objectInput" rows="3" placeholder="Enter text to score"></textarea>
                        </div>
                        
                        <button class="btn btn-success" id="startInferenceBtn">Run Inference</button>
                        
                        <div class="mt-4">
                            <h6>Inference Status</h6>
                            <div id="inferenceStatus">
                                <div class="alert alert-info">Select a model and enter text to score</div>
                            </div>
                            
                            <h6 class="mt-4">Inference Output</h6>
                            <div id="inferenceOutput" class="bg-dark text-light p-3 overflow-auto" style="height: 300px; display: none;">
                                <pre id="inferenceLog" class="mb-0 text-light"></pre>
                            </div>
                            
                            <div id="inferenceResults" class="mt-4" style="display: none;">
                                <h6>Results</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h5 class="card-title">Final Score</h5>
                                                <h2 id="finalScore" class="text-center">-</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h5 class="card-title">Visualization</h5>
                                                <div id="figureContainer">
                                                    <img id="resultFigure" src="" alt="Scoring Visualization" class="img-fluid" style="display: none;">
                                                    <div id="noFigureMessage" class="text-center text-muted">No visualization available</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script>
        // Data preparation tab functions
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('datasetFile');
            const uploadBtn = document.getElementById('uploadBtn');
            const resultDiv = document.getElementById('uploadResult');
            
            if (!fileInput.files.length) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please select a file to upload.</div>';
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            // Disable button during upload
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            
            fetch('/api/upload-dataset', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            })
            .finally(() => {
                // Re-enable button
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Dataset';
            });
        });
        
        // Function to fetch and display datasets
        function loadDatasets() {
            const datasetsList = document.getElementById('datasetsList');
            datasetsList.innerHTML = '<div class="alert alert-info">Loading datasets...</div>';
            
            fetch('/api/datasets')
            .then(response => response.json())
            .then(datasets => {
                if (datasets.length === 0) {
                    datasetsList.innerHTML = '<div class="alert alert-warning">No datasets uploaded yet.</div>';
                    return;
                }
                
                let listHtml = '<ul class="list-group">';
                datasets.forEach(dataset => {
                    const date = new Date(dataset.modified * 1000);
                    const dateString = date.toLocaleString();
                    const sizeInKB = (dataset.size / 1024).toFixed(2);
                    listHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>${dataset.name}</span>
                            <small class="text-muted">${sizeInKB} KB | ${dateString}</small>
                        </li>
                    `;
                });
                listHtml += '</ul>';
                datasetsList.innerHTML = listHtml;
            })
            .catch(error => {
                datasetsList.innerHTML = `<div class="alert alert-danger">Error loading datasets: ${error.message}</div>`;
            });
        }
        
        // Load datasets when refresh button is clicked
        document.getElementById('refreshDatasets').addEventListener('click', loadDatasets);
        
        // Load datasets on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDatasets();
            loadTrainingDatasets(); // Also load datasets for training tab
            loadModels(); // Load models for inference tab
        });
        
        // Training tab functions
        function loadTrainingDatasets() {
            const datasetSelect = document.getElementById('datasetSelect');
            
            // Clear current options except the first one
            datasetSelect.innerHTML = '<option value="">Choose a dataset...</option>';
            
            fetch('/api/datasets')
            .then(response => response.json())
            .then(datasets => {
                datasets.forEach(dataset => {
                    const option = document.createElement('option');
                    option.value = dataset.name;
                    option.textContent = dataset.name;
                    datasetSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading training datasets:', error);
            });
        }
        
        // Refresh datasets for training
        document.getElementById('refreshTrainingDatasets').addEventListener('click', loadTrainingDatasets);
        
        // Start training
        let trainingInterval = null;
        document.getElementById('startTrainingBtn').addEventListener('click', function() {
            const datasetSelect = document.getElementById('datasetSelect');
            const selectedDataset = datasetSelect.value;
            const statusDiv = document.getElementById('trainingStatus');
            const outputDiv = document.getElementById('trainingOutput');
            const logPre = document.getElementById('trainingLog');
            
            if (!selectedDataset) {
                statusDiv.innerHTML = '<div class="alert alert-warning">Please select a dataset first.</div>';
                return;
            }
            
            // Reset UI
            statusDiv.innerHTML = '<div class="alert alert-info">Starting training...</div>';
            logPre.textContent = '';
            outputDiv.style.display = 'block';
            
            // Send request to start training
            fetch('/api/start-training', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ dataset: selectedDataset })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    statusDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                statusDiv.innerHTML = `<div class="alert alert-info">Training started with ID: ${data.training_id}</div>`;
                
                // Poll for training updates
                if (trainingInterval) {
                    clearInterval(trainingInterval);
                }
                
                trainingInterval = setInterval(() => {
                    fetch(`/api/training-status/${data.training_id}`)
                    .then(response => response.json())
                    .then(statusData => {
                        if (statusData.error) {
                            statusDiv.innerHTML = `<div class="alert alert-danger">${statusData.error}</div>`;
                            clearInterval(trainingInterval);
                            return;
                        }
                        
                        // Update status
                        statusDiv.innerHTML = `<div class="alert alert-info">Status: ${statusData.status}</div>`;
                        
                        // Update log
                        if (statusData.output && statusData.output.length > 0) {
                            logPre.textContent = statusData.output.join('');
                            // Auto-scroll to bottom
                            outputDiv.scrollTop = outputDiv.scrollHeight;
                        }
                        
                        // Stop polling if training is completed or failed
                        if (statusData.status === 'completed' || statusData.status === 'failed') {
                            clearInterval(trainingInterval);
                            statusDiv.innerHTML = `<div class="alert alert-${statusData.status === 'completed' ? 'success' : 'danger'}">
                                Training ${statusData.status}
                            </div>`;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching training status:', error);
                    });
                }, 1000); // Poll every second
            })
            .catch(error => {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error starting training: ${error.message}</div>`;
            });
        });
        
        // Inference tab functions
        function loadModels() {
            const modelSelect = document.getElementById('modelSelect');
            modelSelect.innerHTML = '<option value="">Choose a model...</option>';
            
            fetch('/api/models')
            .then(response => response.json())
            .then(models => {
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    modelSelect.appendChild(option);
                });
                
                if (models.length === 0) {
                    modelSelect.innerHTML = '<option value="">No models available</option>';
                }
            })
            .catch(error => {
                console.error('Error loading models:', error);
            });
        }
        
        // Refresh models
        document.getElementById('refreshModels').addEventListener('click', loadModels);
        
        // Start inference
        let inferenceInterval = null;
        document.getElementById('startInferenceBtn').addEventListener('click', function() {
            const modelSelect = document.getElementById('modelSelect');
            const standardInput = document.getElementById('standardInput');
            const objectInput = document.getElementById('objectInput');
            
            const selectedModel = modelSelect.value;
            const standard = standardInput.value.trim();
            const obj = objectInput.value.trim();
            
            const statusDiv = document.getElementById('inferenceStatus');
            const outputDiv = document.getElementById('inferenceOutput');
            const logPre = document.getElementById('inferenceLog');
            const resultsDiv = document.getElementById('inferenceResults');
            const finalScoreEl = document.getElementById('finalScore');
            const resultFigure = document.getElementById('resultFigure');
            const noFigureMessage = document.getElementById('noFigureMessage');
            
            // Validation
            if (!selectedModel) {
                statusDiv.innerHTML = '<div class="alert alert-warning">Please select a model first.</div>';
                return;
            }
            
            if (!standard) {
                statusDiv.innerHTML = '<div class="alert alert-warning">Please enter a scoring standard.</div>';
                return;
            }
            
            if (!obj) {
                statusDiv.innerHTML = '<div class="alert alert-warning">Please enter text to score.</div>';
                return;
            }
            
            // Reset UI
            statusDiv.innerHTML = '<div class="alert alert-info">Starting inference...</div>';
            logPre.textContent = '';
            outputDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            finalScoreEl.textContent = '-';
            resultFigure.style.display = 'none';
            noFigureMessage.style.display = 'block';
            
            // Send request to start inference
            fetch('/api/start-inference', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    model: selectedModel,
                    standard: standard,
                    obj: obj
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    statusDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                statusDiv.innerHTML = `<div class="alert alert-info">Inference started with ID: ${data.inference_id}</div>`;
                
                // Poll for inference updates
                if (inferenceInterval) {
                    clearInterval(inferenceInterval);
                }
                
                inferenceInterval = setInterval(() => {
                    fetch(`/api/inference-status/${data.inference_id}`)
                    .then(response => response.json())
                    .then(statusData => {
                        if (statusData.error) {
                            statusDiv.innerHTML = `<div class="alert alert-danger">${statusData.error}</div>`;
                            clearInterval(inferenceInterval);
                            return;
                        }
                        
                        // Update status
                        statusDiv.innerHTML = `<div class="alert alert-info">Status: ${statusData.status}</div>`;
                        
                        // Update log
                        if (statusData.output && statusData.output.length > 0) {
                            logPre.textContent = statusData.output.join('');
                            // Auto-scroll to bottom
                            outputDiv.scrollTop = outputDiv.scrollHeight;
                        }
                        
                        // Handle completion
                        if (statusData.status === 'completed' || statusData.status === 'completed_with_errors') {
                            clearInterval(inferenceInterval);
                            
                            if (statusData.status === 'completed') {
                                statusDiv.innerHTML = '<div class="alert alert-success">Inference completed successfully</div>';
                            } else {
                                statusDiv.innerHTML = '<div class="alert alert-warning">Inference completed with errors in figure generation</div>';
                            }
                            
                            // Try to parse output lines to find the final score
                            try {
                                let foundScore = false;
                                // Check each line for the score information
                                for (let i = 0; i < statusData.output.length; i++) {
                                    const line = statusData.output[i];
                                    if (line.includes('最终评分:') || line.includes('Final Score:')) {
                                        const match = line.match(/(\d+\.\d+)/);
                                        if (match) {
                                            finalScoreEl.textContent = parseFloat(match[1]).toFixed(4);
                                            foundScore = true;
                                            break;
                                        }
                                    }
                                }
                                
                                // If not found in formatted lines, try to parse as JSON
                                if (!foundScore) {
                                    for (let i = 0; i < statusData.output.length; i++) {
                                        try {
                                            const parsed = JSON.parse(statusData.output[i]);
                                            if (parsed.final_score !== undefined) {
                                                finalScoreEl.textContent = parseFloat(parsed.final_score).toFixed(4);
                                                foundScore = true;
                                                break;
                                            }
                                        } catch (e) {
                                            // Not a JSON line, continue
                                        }
                                    }
                                }
                            } catch (e) {
                                console.error('Could not parse final score from output');
                            }
                            
                            // Show results section
                            resultsDiv.style.display = 'block';
                            
                            // Generate figure if not already provided
                            if (!statusData.figure) {
                                fetch('/api/generate-figure', {
                                    method: 'POST'
                                })
                                .then(response => response.json())
                                .then(figureData => {
                                    if (figureData.figure) {
                                        resultFigure.src = `/figures/${figureData.figure}`;
                                        resultFigure.style.display = 'block';
                                        noFigureMessage.style.display = 'none';
                                    }
                                })
                                .catch(error => {
                                    console.error('Error generating figure:', error);
                                });
                            } else {
                                // Display figure if available
                                resultFigure.src = `/figures/${statusData.figure}`;
                                resultFigure.style.display = 'block';
                                noFigureMessage.style.display = 'none';
                            }
                        } else if (statusData.status === 'failed') {
                            clearInterval(inferenceInterval);
                            statusDiv.innerHTML = '<div class="alert alert-danger">Inference failed</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching inference status:', error);
                    });
                }, 1000); // Poll every second
            })
            .catch(error => {
                statusDiv.innerHTML = `<div class="alert alert-danger">Error starting inference: ${error.message}</div>`;
            });
        });
    </script>
</body>
</html>